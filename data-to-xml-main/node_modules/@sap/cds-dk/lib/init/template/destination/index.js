const { readProject } = require('../../projectReader')
const { merge } = require('../../merge')
const { srv4, approuter, destination, mtxSidecar4 } = require('../../registries/mta')

module.exports = class DestinationTemplate extends require('../../plugin') {

    static help() {
        return 'SAP BTP Destination Service'
    }

    static hasInProduction(env) {
        const kinds = { odata: 1, 'odata-v2': 1, 'odata-v4': 1, rest: 1 }
        const mtxServices = { 'cds.xt.SaasProvisioningService': 1, 'cds.xt.DeploymentService': 1, 'cds.xt.ModelProviderService': 1, 'cds.xt.ExtensibilityService': 1 }
        const _fromMtx = service => service in mtxServices
        const hasDestination = Object.entries(env.requires).some(([service, require]) => !_fromMtx(service) && !kinds[service] && kinds[require.kind])
        return hasDestination || !!env.requires.destinations
    }

    async run() {
        const project = readProject()
        const { configFile } = project
        await merge(__dirname, 'files', 'package.json.hbs').into(configFile, { with: project })
    }

    async combine() {
        const project = readProject()
        const { hasHelm, hasApprouter, hasMultitenancy, hasHelmUnifiedRuntime, hasMta, srvPath, isJava } = project

        if (hasMultitenancy) {
            await merge(__dirname, 'files/package.sidecar.json').into('mtx/sidecar/package.json')
        }

        if (hasMta) {
            const srv = srv4(srvPath)
            const additions = [srv, destination]
            const relationships = [{
                insert: [destination, 'name'],
                into: [srv, 'requires', 'name']
            }]
            if (hasApprouter) {
                relationships.push({
                    insert: [destination, 'name'],
                    into: [approuter, 'requires', 'name']
                })
            }
            if (hasMultitenancy) {
                relationships.push({
                    insert: [destination, 'name'],
                    into: [mtxSidecar4(isJava ? 'mtx/sidecar' : 'gen/mtx/sidecar'), 'requires', 'name']
                })
            }
            await merge(__dirname, 'files/mta.yaml.hbs').into('mta.yaml', { with: project, additions, relationships })
        }

        if (hasHelm || hasHelmUnifiedRuntime) {
            await merge(__dirname, 'files/values.yaml').into('chart/values.yaml')
        }
    }
}
