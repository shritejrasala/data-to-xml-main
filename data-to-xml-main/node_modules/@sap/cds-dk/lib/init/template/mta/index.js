const { join } = require('path')
const cds = require('../../../cds')
const { exists } = cds.utils
const { bold } = require('../../../util/term')
const { copyRenderedYAML } = require('../../../util/fs')
const { readProject } = require('../../projectReader')
const { merge, sort } = require('../../merge')
const { mvn } = require('../../add')

module.exports = class MtaTemplate extends require('../../plugin') {

    static help() {
        return 'Cloud Foundry deployment using mta.yaml'
    }

    static hasInProduction() {
        return exists('mta.yaml')
    }

    async run() {
        const project = readProject()
        if (!exists('mta.yaml')) {
            await copyRenderedYAML(join(__dirname, 'files', 'mta.yaml.hbs'), 'mta.yaml', project)
        }
        await merge(__dirname, 'files/package.json').into('package.json')
        await sort('package.json', 'devDependencies')
        if (project.isJava) await mvn.add('cf')
    }

    async finalize() {
        if (!exists('pom.xml')) console.log(`\nRun ${bold('npm update --package-lock-only')} to freeze dependencies.`)
    }
}
